package cn.chain33.javasdk.client;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;

import cn.chain33.javasdk.model.rpcresult.QueryTransactionResult;

public class EVMTest {
	
	// json/rpc connection
	RpcClient client = new RpcClient("localhost", 8801);
	
	private static String execer = "evm";
	
	// 创建EVM的actionName
	private static String actionNameCreate = "CreateCall";
	
	// solidity 编译好的code
	private static String createcode = "606060405260008055341561001357600080fd5b6116ef806100226000396000f300606060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633d4dfc6d1461007d5780634b6956141461029757806363767ea1146102c05780639355a9ba1461040e578063977fecfd1461047f578063fa85c9901461056b575b600080fd5b341561008857600080fd5b61009e60048080359060200190919050506107bf565b604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200186815260200180602001806020018060200185810385528a818151815260200191508051906020019080838360005b83811015610122578082015181840152602081019050610107565b50505050905090810190601f16801561014f5780820380516001836020036101000a031916815260200191505b50858103845288818151815260200191508051906020019080838360005b8381101561018857808201518184015260208101905061016d565b50505050905090810190601f1680156101b55780820380516001836020036101000a031916815260200191505b50858103835287818151815260200191508051906020019080838360005b838110156101ee5780820151818401526020810190506101d3565b50505050905090810190601f16801561021b5780820380516001836020036101000a031916815260200191505b50858103825286818151815260200191508051906020019080838360005b83811015610254578082015181840152602081019050610239565b50505050905090810190601f1680156102815780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b34156102a257600080fd5b6102aa610b34565b6040518082815260200191505060405180910390f35b34156102cb57600080fd5b61040c600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610b3d565b005b341561041957600080fd5b610469600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610c7d565b6040518082815260200191505060405180910390f35b341561048a57600080fd5b610569600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091908035906020019091905050610fdf565b005b341561057657600080fd5b6105c6600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506113fd565b604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200186815260200180602001806020018060200185810385528a818151815260200191508051906020019080838360005b8381101561064a57808201518184015260208101905061062f565b50505050905090810190601f1680156106775780820380516001836020036101000a031916815260200191505b50858103845288818151815260200191508051906020019080838360005b838110156106b0578082015181840152602081019050610695565b50505050905090810190601f1680156106dd5780820380516001836020036101000a031916815260200191505b50858103835287818151815260200191508051906020019080838360005b838110156107165780820151818401526020810190506106fb565b50505050905090810190601f1680156107435780820380516001836020036101000a031916815260200191505b50858103825286818151815260200191508051906020019080838360005b8381101561077c578082015181840152602081019050610761565b50505050905090810190601f1680156107a95780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b60006107c9611591565b60006107d3611591565b6107db611591565b6107e3611591565b6107eb6115a5565b6001600089815260200190815260200160002060c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108f95780601f106108ce576101008083540402835291602001916108f9565b820191906000526020600020905b8154815290600101906020018083116108dc57829003601f168201915b5050505050815260200160028201548152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109a55780601f1061097a576101008083540402835291602001916109a5565b820191906000526020600020905b81548152906001019060200180831161098857829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a475780601f10610a1c57610100808354040283529160200191610a47565b820191906000526020600020905b815481529060010190602001808311610a2a57829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ae95780601f10610abe57610100808354040283529160200191610ae9565b820191906000526020600020905b815481529060010190602001808311610acc57829003601f168201915b5050505050815250509050806000015181602001518260400151836060015184608001518560a001518494508292508191508090509650965096509650965096505091939550919395565b60008054905090565b610b456115a5565b60c0604051908101604052808873ffffffffffffffffffffffffffffffffffffffff16815260200187815260200186815260200185815260200184815260200183815250905080600160008054815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001019080519060200190610c0392919061160a565b50604082015181600201556060820151816003019080519060200190610c2a92919061160a565b506080820151816004019080519060200190610c4792919061160a565b5060a0820151816005019080519060200190610c6492919061160a565b5090505060016000540160008190555050505050505050565b6000806000610c8a6115a5565b60008092505b6000548360ff161015610fd357600160008460ff16815260200190815260200160002060c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610dae5780601f10610d8357610100808354040283529160200191610dae565b820191906000526020600020905b815481529060010190602001808311610d9157829003601f168201915b5050505050815260200160028201548152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e5a5780601f10610e2f57610100808354040283529160200191610e5a565b820191906000526020600020905b815481529060010190602001808311610e3d57829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610efc5780601f10610ed157610100808354040283529160200191610efc565b820191906000526020600020905b815481529060010190602001808311610edf57829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f9e5780601f10610f7357610100808354040283529160200191610f9e565b820191906000526020600020905b815481529060010190602001808311610f8157829003601f168201915b5050505050815250509150610fb786836060015161144d565b90508015610fc6578260ff1693505b8280600101935050610c90565b83945050505050919050565b6000610fe96115a5565b610ff286610c7d565b91506001600083815260200190815260200160002060c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111025780601f106110d757610100808354040283529160200191611102565b820191906000526020600020905b8154815290600101906020018083116110e557829003601f168201915b5050505050815260200160028201548152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111ae5780601f10611183576101008083540402835291602001916111ae565b820191906000526020600020905b81548152906001019060200180831161119157829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156112505780601f1061122557610100808354040283529160200191611250565b820191906000526020600020905b81548152906001019060200180831161123357829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156112f25780601f106112c7576101008083540402835291602001916112f2565b820191906000526020600020905b8154815290600101906020018083116112d557829003601f168201915b505050505081525050905084816020018190525083816080018190525082816040018181525050806001600084815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101908051906020019061139092919061160a565b506040820151816002015560608201518160030190805190602001906113b792919061160a565b5060808201518160040190805190602001906113d492919061160a565b5060a08201518160050190805190602001906113f192919061160a565b50905050505050505050565b6000611407611591565b6000611411611591565b611419611591565b611421611591565b600061142c88610c7d565b9050611437816107bf565b9650965096509650965096505091939550919395565b60008082518451141515611464576000915061158a565b600090505b835181101561158557828181518110151561148057fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191684828151811015156114fb57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916141515611578576000915061158a565b8080600101915050611469565b600191505b5092915050565b602060405190810160405280600081525090565b60c060405190810160405280600073ffffffffffffffffffffffffffffffffffffffff1681526020016115d661168a565b8152602001600081526020016115ea61168a565b81526020016115f761168a565b815260200161160461168a565b81525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061164b57805160ff1916838001178555611679565b82800160010185558215611679579182015b8281111561167857825182559160200191906001019061165d565b5b509050611686919061169e565b5090565b602060405190810160405280600081525090565b6116c091905b808211156116bc5760008160009055506001016116a4565b5090565b905600a165627a7a72305820c47606ac1ae869f67ac499a8f58e8afba34c60f3eec5748efb261ff54cdd779f0029";
	
	// abi
	private static String abi = "[{\"constant\":true,\"inputs\":[{\"name\":\"_index\",\"type\":\"uint256\"}],\"name\":\"getMdInfoByIndex\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"getMdNumber\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"_creator\",\"type\":\"address\"},{\"name\":\"_name\",\"type\":\"string\"},{\"name\":\"_price\",\"type\":\"uint256\"},{\"name\":\"_codeno\",\"type\":\"string\"},{\"name\":\"_batchno\",\"type\":\"string\"},{\"name\":\"_desc\",\"type\":\"string\"}],\"name\":\"addMdInfo\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"_codeno\",\"type\":\"string\"}],\"name\":\"getMdIndexByCodeNo\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"_codeno\",\"type\":\"string\"},{\"name\":\"_name\",\"type\":\"string\"},{\"name\":\"_batchno\",\"type\":\"string\"},{\"name\":\"_price\",\"type\":\"uint256\"}],\"name\":\"updateMdInfoByCodeNo\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"_codeno\",\"type\":\"string\"}],\"name\":\"getMdInfoByCodeNo\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"}]";
	
	// 发起合约的地址和私钥
	private static String address = "1CbEVT9RnM5oZhWMj4fxUrJX94VtRotzvs";
	private static String secret = "3990969DF92A5914F7B71EEB9A4E58D6E255F32BF042FEA5318FC8B3D50EE6E8";
	
	public static void main(String[] args) throws Exception {
		EVMTest evmTest = new EVMTest();
		
		JSONObject payload = new JSONObject();
		
		// 创建EVM合约
		payload.put("code", createcode);
		payload.put("abi", abi);
		payload.put("note", "EVMCreate");
		payload.put("fee", 10000000);
		payload.put("isCreate", true);

		String unsignTx = evmTest.createTransaction(payload);
		String signTx = evmTest.signRawTx(address, secret, unsignTx, "1h", 1);
		String txhashCreate = evmTest.submitTransaction(signTx);
		evmTest.querytxWithoutContent(txhashCreate);
		
		payload = new JSONObject();
		// 调用EVM合约(addMdInfo)
		payload.put("name", "user.evm." + txhashCreate);
		payload.put("isCreate", false);
		payload.put("abi", "addMdInfo(\"1CbEVT9RnM5oZhWMj4fxUrJX94VtRotzvs\",\"name\",\"12000\",\"number001\",\"pihao002\",\"desc\")");
		
		
		// 获取合约对应的地址
		String contractAddress = evmTest.converAddress("user.evm." + txhashCreate);
		
		unsignTx = evmTest.createTransaction(payload);
		signTx = evmTest.signRawTx(address, secret, unsignTx, "1h", 1);
		String txhash = evmTest.submitTransaction(signTx);
		evmTest.querytxWithoutContent(txhash);
		
		payload = new JSONObject();
		JSONObject requestParam = new JSONObject();
		requestParam.put("execer", execer);
		requestParam.put("funcName", "Query");
		// 查询: getMdNumber
		payload.put("address", contractAddress);
		payload.put("input", "getMdNumber()");
		payload.put("caller", address);
		requestParam.put("payload", payload);

		JSONArray getMdNumberResulst = evmTest.queryEVMByABI(requestParam);
		System.out.println(getMdNumberResulst);
		
		payload = new JSONObject();
		requestParam = new JSONObject();
		requestParam.put("execer", execer);
		requestParam.put("funcName", "Query");
		// 查询: getMdIndexByCodeNo
		payload.put("address", contractAddress);
		payload.put("input", "getMdIndexByCodeNo(\"number001\")");
		payload.put("caller", address);
		requestParam.put("payload", payload);

		JSONArray getMdIndexByCodeNoResulst = evmTest.queryEVMByABI(requestParam);
		System.out.println(getMdIndexByCodeNoResulst);
	}
	
	public String createTransaction(JSONObject payload) throws Exception {
		String unsignTx = client.createTransaction(execer, actionNameCreate, payload);
		return unsignTx;
	}

	public String signRawTx(String addr, String key, String txhex, String expire, int index) {
		String signTx = client.signRawTx(addr, key, txhex, expire, index);
		return signTx;
	}

	public String submitTransaction(String data) {
		String sendResult = client.submitTransaction(data);
		return sendResult;
	}
	
	public JSONArray queryEVMByABI(JSONObject requestParam) throws Exception {
		JSONArray unsignTx = client.queryEVMByABI(requestParam);
		return unsignTx;
	}
	
	
	public void querytxWithoutContent(String txHash) throws InterruptedException {
		
		QueryTransactionResult queryTransaction = new QueryTransactionResult();
		// 打包区块可能会有一定延时，这边等待一会
		for (int i = 0; i < 50; i++) {
			Thread.sleep(1000);
			queryTransaction = client.queryTransaction(txHash);
			if (null == queryTransaction) {
				Thread.sleep(1000);
			} else {
				break;
			}
		}
		
		// 获得区块高度
		System.out.println("区块高度：" + queryTransaction.getHeight() + "区块时间：" + queryTransaction.getBlocktime()
				+ "区块hash:" + client.getBlockHash(queryTransaction.getHeight()) + "交易hash:" + txHash);
	}
	
	/**
	 * Get the contract address
	 */
	public String converAddress(String execerName) {
		String address = client.convertExectoAddr(execerName);
		return address;
	}

}
